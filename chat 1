<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp - Wajira</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        :root { --wa-header:#075e54; --wa-bg:#efe7dd; --wa-sent:#e7ffdb; --wa-received:#ffffff; --wa-time:#667781; }
        body { font-family:'Segoe UI', Tahoma, sans-serif; background:#d1d7db; margin:0; display:flex; justify-content:center; align-items:center; height:100vh; }
        .chat-container { width:360px; height:640px; background:var(--wa-bg) url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); display:flex; flex-direction:column; box-shadow:0 10px 25px rgba(0,0,0,0.2); overflow:hidden; }
        .header { background:var(--wa-header); color:white; padding:10px 12px; display:flex; align-items:center; height:45px; z-index:10; }
        .header img { width:35px; height:35px; border-radius:50%; margin-right:10px; object-fit:cover; }
        .header-info { flex:1; }
        .chat-body { flex:1; overflow-y:auto; padding:10px 12px; display:flex; flex-direction:column; }
        .date-header { align-self:center; background:#fff; font-size:11px; padding:4px 12px; border-radius:6px; margin:10px 0; color:#54656f; box-shadow:0 1px 0.5px rgba(0,0,0,0.1); }
        .message { max-width:72%; padding:6px 9px; border-radius:8px; font-size:14px; margin-bottom:5px; box-shadow:0 1px 1px rgba(0,0,0,0.1); position:relative; line-height:1.4; }
        .sent { align-self:flex-end; background:var(--wa-sent); border-top-right-radius:0; }
        .msg-row { display:flex; align-items:flex-start; gap:5px; align-self:flex-start; }
        .received { background:var(--wa-received); border-top-left-radius:0; }
        .receiver-avatar { width:28px; height:28px; border-radius:50%; object-fit:cover; }
        .time { font-size:10px; color:var(--wa-time); display:flex; justify-content:flex-end; margin-top:2px; }
        .input-area { background:#f0f2f5; padding:10px; display:flex; align-items:center; gap:8px; }
        .input-wrapper { flex:1; background:white; border-radius:25px; display:flex; align-items:center; padding:0 12px; height:40px; }
        .input-box { flex:1; border:none; outline:none; padding:0 8px; font-size:15px; }
        .action-btn { background:#00a884; color:white; width:40px; height:40px; border-radius:50%; border:none; cursor:pointer; }
        .msg-img { max-width:100%; border-radius:5px; margin-top:5px; }
        .recording { color:red !important; animation:blink 1s infinite; }
        @keyframes blink { 50% { opacity:0; } }
        .msg-options { display:none; position:absolute; background:white; box-shadow:0 2px 10px rgba(0,0,0,0.2); border-radius:5px; z-index:100; font-size:13px; width:150px; }
        .msg-options div { padding:10px; cursor:pointer; border-bottom:1px solid #eee; }
    </style>
</head>
<body>
<div class="chat-container">
    <div class="header">
        <i class="fa-solid fa-arrow-left"></i> &nbsp;
        <img src="https://109689417-706007161726271742.preview.editmysite.com/uploads/1/0/9/6/109689417/editor/whatsapp-image-2026-02.jpeg?1770889306">
        <div class="header-info"><span style="font-weight:500;">Thushara</span><br><span style="font-size:11px; opacity:0.8">online</span></div>
        <div style="display:flex; gap:18px; font-size:18px;"><i class="fa-solid fa-video"></i><i class="fa-solid fa-phone"></i><i class="fa-solid fa-ellipsis-vertical"></i></div>
    </div>
    <div class="chat-body" id="chat-content"></div>
    <div class="input-area">
        <div class="input-wrapper">
            <i class="fa-solid fa-paperclip" style="color:#667781; cursor:pointer;" onclick="document.getElementById('file-input').click()"></i>
            <input type="file" id="file-input" style="display:none" accept="image/*">
            <input type="text" class="input-box" id="msg-input" placeholder="Message" autocomplete="off">
        </div>
        <button class="action-btn" id="send-btn"><i class="fa-solid fa-microphone" id="mic-icon"></i></button>
    </div>
</div>
<div id="msg-menu" class="msg-options">
    <div onclick="deleteMsg('me')">Delete for me</div>
    <div onclick="deleteMsg('everyone')">Delete for everyone</div>
</div>

<script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbwZBJ2K20L8mtYlJ1cdkG4v3L5PZmOKBCfpxEXtPuAH4Pm2cfFqqqZ0OXshRYfSes-1Sw/exec';
    const myUserType = "Wajira";
    const partnerPic = "https://109689417-706007161726271742.preview.editmysite.com/uploads/1/0/9/6/109689417/editor/whatsapp-image-2026-02.jpeg?1770889306";

    let lastShownDate = ""; let selectedMsg = null; let mediaRecorder; let audioChunks = [];
    const inputField = document.getElementById('msg-input');
    const sendBtn = document.getElementById('send-btn');
    const micIcon = document.getElementById('mic-icon');
    const chatBody = document.getElementById('chat-content');

    inputField.oninput = () => { micIcon.className = inputField.value.trim() ? "fa-solid fa-paper-plane" : "fa-solid fa-microphone"; };

    document.getElementById('file-input').onchange = (e) => {
        const reader = new FileReader();
        reader.onload = () => sendData(`[IMG]:${reader.result}`);
        reader.readAsDataURL(e.target.files[0]);
    };

    micIcon.onmousedown = async () => {
        if(inputField.value.trim()) return;
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.start();
        micIcon.classList.add('recording');
        audioChunks = [];
        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        mediaRecorder.onstop = () => {
            const reader = new FileReader();
            reader.onload = () => sendData(`[AUDIO]:${reader.result}`);
            reader.readAsDataURL(new Blob(audioChunks, { type: 'audio/mpeg' }));
            micIcon.classList.remove('recording');
        };
    };
    window.onmouseup = () => { if(mediaRecorder?.state === "recording") mediaRecorder.stop(); };

    async function sendData(msg) {
        appendMessage(msg, 'sent', new Date());
        await fetch(scriptURL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ user: myUserType, message: msg }) });
    }

    sendBtn.onclick = () => { if(inputField.value.trim()) sendData(inputField.value.trim()); inputField.value = ""; micIcon.className = "fa-solid fa-microphone"; };

    function appendMessage(text, type, timestamp) {
        const msgDate = new Date(timestamp);
        const dateStr = msgDate.toLocaleDateString('en-GB', { day:'numeric', month:'long', year:'numeric' });
        if (dateStr !== lastShownDate) {
            const d = document.createElement('div'); d.className='date-header'; d.innerText=dateStr; chatBody.appendChild(d); lastShownDate=dateStr;
        }
        const timeStr = msgDate.toLocaleTimeString([], { hour:'2-digit', minute:'2-digit', hour12:false });
        const wrapper = document.createElement('div'); wrapper.className = type==='sent' ? 'message sent' : 'msg-row';
        wrapper.oncontextmenu = (e) => { e.preventDefault(); selectedMsg=wrapper; const m=document.getElementById('msg-menu'); m.style.display='block'; m.style.left=e.pageX+'px'; m.style.top=e.pageY+'px'; };

        let content = text;
        if(text === "[DELETED]") content = "<i><i class='fa-solid fa-ban'></i> This message was deleted</i>";
        else if(text.startsWith("[IMG]:")) content = `<img src="${text.split('[IMG]:')[1]}" class="msg-img">`;
        else if(text.startsWith("[AUDIO]:")) content = `<audio controls src="${text.split('[AUDIO]:')[1]}" style="height:35px; width:180px; margin-top:5px;"></audio>`;

        if(type==='sent') wrapper.innerHTML = `${content}<div class="time">${timeStr} <i class="fa-solid fa-check-double" style="color:#53bdeb"></i></div>`;
        else wrapper.innerHTML = `<img src="${partnerPic}" class="receiver-avatar"><div class="message received">${content}<div class="time">${timeStr}</div></div>`;
        chatBody.appendChild(wrapper); chatBody.scrollTop = chatBody.scrollHeight;
    }

    function deleteMsg(scope) { if(scope==='everyone') sendData("[DELETED]"); selectedMsg.remove(); }
    window.onclick = () => document.getElementById('msg-menu').style.display='none';

    let lastCount = 0;
    setInterval(async () => {
        try {
            const res = await fetch(scriptURL); const data = await res.json();
            if (data.length > lastCount) {
                for (let i = lastCount; i < data.length; i++) {
                    if (data[i][1] !== myUserType) appendMessage(data[i][2], 'received', data[i][0]);
                    else if (lastCount === 0) appendMessage(data[i][2], 'sent', data[i][0]);
                }
                lastCount = data.length;
            }
        } catch(e){}
    }, 3000);
</script>
</body>
</html>
